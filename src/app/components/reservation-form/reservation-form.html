<section id="reservar" class="reserva">
  <div class="container">
    <h2>Reserv√° tu Mesa</h2>
    <p>Complet√° tus datos y asegur√° tu lugar en Flynn Irish Bar</p>

    <!-- GATE DE PAGO: si todav√≠a no hay pago exitoso -->
    <div *ngIf="formBloqueado; else formBlock" class="pay-card">
      <h3>Se√±a para reservar</h3>
      <p>Para continuar, abon√° una se√±a de <b>${{ amount || 10 }}</b>.</p>
      <p class="muted">{{ desc }}</p>

      <button class="btn" type="button" (click)="iniciarPago()" [disabled]="paying">
        {{ paying ? 'Redirigiendo‚Ä¶' : 'Pagar se√±a con Mercado Pago' }}
      </button>

      <p class="info" *ngIf="paid==='0'">El pago fue cancelado. Pod√©s intentarlo de nuevo.</p>
      <p class="info" *ngIf="paid==='pending'">El pago qued√≥ pendiente. Te avisaremos cuando se acredite.</p>
      <p class="error" *ngIf="error">‚ö†Ô∏è {{ error }}</p>
    </div>

    <!-- FORMULARIO: solo se muestra cuando paid=1 -->
    <ng-template #formBlock>
      <div class="ok">‚úÖ Pago recibido. Complet√° el formulario para agendar tu reserva.</div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <!-- Selecci√≥n de sitio -->
        <div class="sitios">
          <h3>Seleccion√° tu sitio preferido</h3>
          <div class="sitios-grid">
            <button
              type="button"
              *ngFor="let s of sitios"
              (click)="seleccionarSitio(s.nombre)"
              [class.activo]="sitioSeleccionado === s.nombre">
              <span class="icon">{{ s.icono }}</span>
              <span>{{ s.nombre }}</span>
            </button>
          </div>
          <small class="err" *ngIf="f.sitio.touched && f.sitio.invalid">Eleg√≠ un sector</small>
        </div>

        <!-- Datos personales -->
        <div class="grid">
          <label>
            <span>Nombre completo</span>
            <input formControlName="nombre" type="text" placeholder="San Patricio üçÄ" />
            <small class="err" *ngIf="f.nombre.touched && f.nombre.invalid">
              Ingres√° tu nombre (m√≠n. 2 caracteres).
            </small>
          </label>

          <label>
            <span>Tel√©fono</span>
            <input formControlName="telefono" type="tel" placeholder="+54 11 1234-5678" />
          </label>

          <label>
            <span>Email</span>
            <input formControlName="email" type="email" placeholder="tu@email.com" />
            <small class="err" *ngIf="f.email.touched && f.email.invalid">Ingres√° un email v√°lido.</small>
          </label>

          <label>
            <span>Fecha</span>
            <input formControlName="fecha" type="date" />
            <small class="err" *ngIf="f.fecha.touched && f.fecha.invalid">Eleg√≠ una fecha.</small>
          </label>

          <label>
            <span>Horario</span>
            <input formControlName="hora" type="time" />
            <small class="err" *ngIf="f.hora.touched && f.hora.invalid">Eleg√≠ un horario.</small>
          </label>

          <label>
            <span>Personas</span>
            <input formControlName="personas" type="number" min="1" />
            <small class="err" *ngIf="f.personas.touched && f.personas.invalid">Indic√° la cantidad.</small>
          </label>
        </div>

        <!-- Notas -->
        <div class="notas">
          <label>
            <span>Notas</span>
            <textarea formControlName="notas" rows="3" placeholder="Algo m√°s a tener en cuenta..."></textarea>
          </label>
        </div>

        <!-- Bot√≥n -->
        <button class="btn" type="submit" [disabled]="cargando || form.invalid">
          {{ cargando ? 'Enviando...' : 'Confirmar Reserva' }}
        </button>

        <!-- Mensajes -->
        <p class="ok" *ngIf="enviado">‚úÖ ¬°Reserva enviada con √©xito! Te enviamos un email de confirmaci√≥n.</p>
        <p class="error" *ngIf="error">‚ö†Ô∏è {{ error }}</p>
      </form>
    </ng-template>
  </div>
</section>
