<section class="dashboard">
  <h2>Panel del Encargado</h2>

  <ng-container *ngIf="needsLogin; else adminView">
    <p>Accedé con tu cuenta autorizada de Google para ver las reservas.</p>
    <div id="googleBtn" style="height:48px;"></div>
    <p class="error" *ngIf="error">⚠️ {{ error }}</p>
  </ng-container>

  <ng-template #adminView>
    <div class="topbar">
      <span>Sesión: <b>{{ meEmail }}</b></span>
      <button class="btn small" type="button" (click)="logout()">Cerrar sesión</button>
    </div>

    <form class="filtros" (ngSubmit)="aplicarFiltros()">
      <div class="grid">
        <label>
          <span>Desde</span>
          <input type="date" [(ngModel)]="filtro.desde" name="desde" />
        </label>

        <label>
          <span>Hasta</span>
          <input type="date" [(ngModel)]="filtro.hasta" name="hasta" [min]="filtro.desde" />
        </label>

        <label>
          <span>Buscar (nombre/email/teléfono)</span>
          <input type="text" [(ngModel)]="filtro.q" name="q" placeholder="Ej: Juan, @gmail.com, +54..." />
        </label>

        <div class="acciones">
          <button class="btn" type="submit" [disabled]="cargando">Filtrar</button>
          <button class="btn sec" type="button" (click)="limpiar()" [disabled]="cargando">Limpiar</button>
        </div>
      </div>
    </form>

    <!-- ==== BLOQUE ESCÁNER QR ==== -->
    <div class="scan-bar">
      <button class="btn" type="button" (click)="startScan()" [disabled]="cargando || scanActive">
        Escanear QR
      </button>
      <button class="btn sec small" type="button" *ngIf="scanActive" (click)="stopScan()">
        Detener
      </button>
    </div>

    <div class="qr-scan" *ngIf="scanActive">
      <video id="qrVideo"
             autoplay
             playsinline
             muted
             style="max-width:320px;width:100%;border-radius:8px;border:1px solid #ccc;">
      </video>
      <p>Apuntá la cámara al QR que muestra el cliente en su correo.</p>
    </div>

    <div class="scan-result" *ngIf="scanMessage">
      <p [class.ok]="scanMatch" [class.error]="!scanMatch">{{ scanMessage }}</p>

      <div *ngIf="scanMatch" class="card">
        <h3>Reserva encontrada</h3>
        <p><b>{{ scanMatch?.nombre }}</b> · {{ scanMatch?.personas }} persona(s)</p>
        <p>{{ scanMatch?.fecha }} {{ scanMatch?.hora }} · {{ scanMatch?.sitio || '-' }}</p>
        <p>{{ scanMatch?.email }} · {{ scanMatch?.telefono }}</p>
      </div>
    </div>
    <!-- ==== FIN BLOQUE ESCÁNER QR ==== -->

    <div class="cards">
      <div class="card"><h3>Total (rango)</h3><p class="kpi">{{ itemsFiltrados().length }}</p></div>
      <div class="card"><h3>Últimos 7 días</h3><p class="kpi">{{ kpiUltimos7 }}</p></div>
      <div class="card"><h3>Próximos 7 días</h3><p class="kpi">{{ kpiProximos7 }}</p></div>
    </div>

    <div class="tabla-wrapper" *ngIf="!cargando; else loading">
      <table class="tabla">
        <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>Nombre</th><th>Email</th>
            <th>Teléfono</th><th>Personas</th><th>Sitio</th><th>Notas</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of itemsFiltrados()">
            <td>{{ r.fecha }}</td>
            <td>{{ r.hora }}</td>
            <td>{{ r.nombre }}</td>
            <td>{{ r.email }}</td>
            <td>{{ r.telefono }}</td>
            <td>{{ r.personas }}</td>
            <td>{{ r.sitio || '-' }}</td>
            <td class="nota">{{ r.comentario || r.notas || '-' }}</td>
          </tr>
        </tbody>
      </table>

      <p *ngIf="itemsFiltrados().length === 0" class="vacio">
        No hay reservas para los filtros aplicados.
      </p>
      <p *ngIf="error" class="error">⚠️ {{ error }}</p>
    </div>

    <ng-template #loading>
      <p>Cargando reservas…</p>
    </ng-template>
  </ng-template>
</section>
